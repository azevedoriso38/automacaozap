<!DOCTYPE html>
<html>
<head>
    <title>Bot WhatsApp</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; margin: 20px; }
        .card { border: 1px solid #ddd; padding: 20px; margin: 10px 0; border-radius: 5px; }
        input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        .btn-primary { background: #25D366; color: white; border: none; }
        .btn-danger { background: #dc3545; color: white; border: none; }
        .hidden { display: none; }
        #qrcode { margin: 10px auto; }
        .status { padding: 10px; margin: 5px 0; }
        .connected { background: #d4edda; }
        .disconnected { background: #f8d7da; }
    </style>
</head>
<body>
    <h1>üì± Bot WhatsApp - Envio em Massa</h1>
    
    <div class="card">
        <h3>üîó Status da Conex√£o</h3>
        <div id="status" class="status disconnected">Desconectado</div>
        <button id="connectBtn" class="btn-primary">Conectar WhatsApp</button>
        <button id="disconnectBtn" class="btn-danger" disabled>Desconectar</button>
        <div id="qrcodeContainer" class="hidden">
            <h4>üì≤ Escaneie o QR Code:</h4>
            <div id="qrcode"></div>
            <p>WhatsApp > ‚ãÆ > Dispositivos conectados > Conectar um dispositivo</p>
        </div>
    </div>

    <div class="card">
        <h3>‚úâÔ∏è Envio em Massa</h3>
        <select id="messageType">
            <option value="text">Texto</option>
            <option value="image">Imagem</option>
        </select>
        
        <textarea id="message" rows="4" placeholder="Digite sua mensagem..."></textarea>
        
        <div id="mediaInput" class="hidden">
            <input type="text" id="mediaUrl" placeholder="URL da imagem...">
        </div>
        
        <textarea id="recipients" rows="4" placeholder="N√∫meros (1 por linha): 5511999999999"></textarea>
        
        <input type="number" id="delay" value="2" min="1" placeholder="Delay entre envios (segundos)">
        
        <button id="sendBtn" class="btn-primary" disabled>Enviar Mensagens</button>
        <button id="stopBtn" class="btn-danger hidden">Parar</button>
        
        <div id="progress" class="hidden">
            <div id="progressBar" style="height:20px;background:#ddd;width:0%"></div>
            <div id="progressText">0/0</div>
        </div>
    </div>

    <div class="card">
        <h3>üìã Logs</h3>
        <div id="logs"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        const socket = io();
        let isSending = false;

        // Elementos
        const statusDiv = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const qrcodeContainer = document.getElementById('qrcodeContainer');
        const qrcodeDiv = document.getElementById('qrcode');
        const sendBtn = document.getElementById('sendBtn');
        const stopBtn = document.getElementById('stopBtn');
        const messageType = document.getElementById('messageType');
        const mediaInput = document.getElementById('mediaInput');
        const progressDiv = document.getElementById('progress');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const logsDiv = document.getElementById('logs');

        // Socket events
        socket.on('connect', () => {
            addLog('Conectado ao servidor');
            socket.emit('check-status');
        });

        socket.on('status', (data) => {
            updateStatus(data);
        });

        socket.on('qr', (qr) => {
            qrcodeContainer.classList.remove('hidden');
            qrcodeDiv.innerHTML = '';
            QRCode.toCanvas(qrcodeDiv, qr, { width: 200 }, (error) => {
                if (error) console.error(error);
            });
        });

        socket.on('ready', () => {
            qrcodeContainer.classList.add('hidden');
            updateStatus({ connected: true, message: 'Conectado!' });
        });

        socket.on('disconnected', () => {
            updateStatus({ connected: false, message: 'Desconectado' });
        });

        socket.on('send-progress', (data) => {
            const percent = (data.sent / data.total) * 100;
            progressBar.style.width = percent + '%';
            progressText.textContent = `${data.sent}/${data.total}`;
            addLog(`${data.status} - ${data.number}`);
        });

        socket.on('send-complete', () => {
            isSending = false;
            sendBtn.disabled = false;
            stopBtn.classList.add('hidden');
            addLog('‚úÖ Envio completo!');
        });

        socket.on('send-error', (error) => {
            addLog(`‚ùå Erro: ${error}`, 'error');
        });

        // Bot√µes
        connectBtn.onclick = () => {
            socket.emit('connect-whatsapp');
            addLog('Iniciando conex√£o...');
        };

        disconnectBtn.onclick = () => {
            socket.emit('disconnect-whatsapp');
        };

        messageType.onchange = () => {
            mediaInput.classList.toggle('hidden', messageType.value === 'text');
        };

        sendBtn.onclick = () => {
            const message = document.getElementById('message').value;
            const recipients = document.getElementById('recipients').value
                .split('\n')
                .filter(num => num.trim());
            const delay = parseInt(document.getElementById('delay').value) || 2;
            const type = messageType.value;
            const mediaUrl = document.getElementById('mediaUrl').value;

            if (!message && type === 'text') {
                alert('Digite uma mensagem!');
                return;
            }

            if (type === 'image' && !mediaUrl) {
                alert('Informe a URL da imagem!');
                return;
            }

            if (recipients.length === 0) {
                alert('Adicione pelo menos um n√∫mero!');
                return;
            }

            socket.emit('send-messages', {
                type,
                message,
                recipients,
                delay,
                mediaUrl
            });

            isSending = true;
            sendBtn.disabled = true;
            stopBtn.classList.remove('hidden');
            progressDiv.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = `0/${recipients.length}`;
            addLog(`üì§ Iniciando envio para ${recipients.length} contatos...`);
        };

        stopBtn.onclick = () => {
            socket.emit('stop-sending');
            isSending = false;
            sendBtn.disabled = false;
            stopBtn.classList.add('hidden');
            addLog('‚èπÔ∏è Envio interrompido');
        };

        // Fun√ß√µes auxiliares
        function updateStatus(data) {
            if (data.connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = '‚úÖ ' + (data.message || 'Conectado');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = '‚ùå ' + (data.message || 'Desconectado');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
                qrcodeContainer.classList.add('hidden');
            }
        }

        function addLog(message, type = 'info') {
            const log = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            log.innerHTML = `[${time}] ${message}`;
            log.style.color = type === 'error' ? '#dc3545' : '#333';
            log.style.margin = '5px 0';
            logsDiv.prepend(log);
        }
    </script>
</body>
</html>
